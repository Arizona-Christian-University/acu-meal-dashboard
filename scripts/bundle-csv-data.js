#!/usr/bin/env node
/**
 * Bundle CSV files as TypeScript modules for Cloudflare Workers
 * This script reads CSV files from the Data directory and converts them
 * to TypeScript modules that can be imported directly
 */

const fs = require('fs');
const path = require('path');

const DATA_DIR = path.join(__dirname, '..', 'Data');
const OUTPUT_DIR = path.join(__dirname, '..', 'lib', 'data');

// Ensure output directory exists
if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR, { recursive: true });
}

// List of CSV files to bundle
const csvFiles = [
  'Atrium Members - Students.csv',
  'Atrium Transactions - Student Meals - Fall 2025 - 7 Meals.csv',
  'Atrium Transactions - Student Meals - Fall 2025 - 14 Meals.csv',
  'Atrium Transactions - Student Meals - Fall 2025 - 19 Meals.csv',
  'Atrium Transactions - Student Flex Dollars - Fall 2025 - Student Flex Dollars (1).csv'
];

console.log('ðŸ“¦ Bundling CSV files for Cloudflare Workers...\n');

csvFiles.forEach(filename => {
  const inputPath = path.join(DATA_DIR, filename);
  const sanitizedName = filename
    .replace(/\.csv$/i, '')
    .replace(/[^a-zA-Z0-9]/g, '_')
    .replace(/_+/g, '_');

  const outputPath = path.join(OUTPUT_DIR, `${sanitizedName}.ts`);

  try {
    const csvContent = fs.readFileSync(inputPath, 'utf-8');
    const escapedContent = csvContent
      .replace(/\\/g, '\\\\')
      .replace(/`/g, '\\`')
      .replace(/\$/g, '\\$');

    const tsContent = `// Auto-generated from ${filename}
// Do not edit this file directly

export const ${sanitizedName} = \`${escapedContent}\`;
`;

    fs.writeFileSync(outputPath, tsContent, 'utf-8');
    console.log(`âœ… ${filename} â†’ ${path.basename(outputPath)}`);
  } catch (error) {
    console.error(`âŒ Failed to bundle ${filename}:`, error.message);
    process.exit(1);
  }
});

// Create index file for easy imports
const indexContent = csvFiles.map((filename, index) => {
  const sanitizedName = filename
    .replace(/\.csv$/i, '')
    .replace(/[^a-zA-Z0-9]/g, '_')
    .replace(/_+/g, '_');

  return `export { ${sanitizedName} } from './${sanitizedName}';`;
}).join('\n') + '\n';

fs.writeFileSync(path.join(OUTPUT_DIR, 'index.ts'), indexContent, 'utf-8');
console.log(`âœ… Created index.ts\n`);
console.log('âœ¨ CSV bundling complete!');
